
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>handler: Go Coverage Report</title>
		<style>
			body {
				background: black;
				color: rgb(80, 80, 80);
			}
			body, pre, #legend span {
				font-family: Menlo, monospace;
				font-weight: bold;
			}
			#topbar {
				background: black;
				position: fixed;
				top: 0; left: 0; right: 0;
				height: 42px;
				border-bottom: 1px solid rgb(80, 80, 80);
			}
			#content {
				margin-top: 50px;
			}
			#nav, #legend {
				float: left;
				margin-left: 10px;
			}
			#legend {
				margin-top: 12px;
			}
			#nav {
				margin-top: 10px;
			}
			#legend span {
				margin: 0 5px;
			}
			.cov0 { color: rgb(192, 0, 0) }
.cov1 { color: rgb(128, 128, 128) }
.cov2 { color: rgb(116, 140, 131) }
.cov3 { color: rgb(104, 152, 134) }
.cov4 { color: rgb(92, 164, 137) }
.cov5 { color: rgb(80, 176, 140) }
.cov6 { color: rgb(68, 188, 143) }
.cov7 { color: rgb(56, 200, 146) }
.cov8 { color: rgb(44, 212, 149) }
.cov9 { color: rgb(32, 224, 152) }
.cov10 { color: rgb(20, 236, 155) }

		</style>
	</head>
	<body>
		<div id="topbar">
			<div id="nav">
				<select id="files">
				
				<option value="file0">github.com/username/warikan/services/group/internal/handler/group.go (100.0%)</option>
				
				<option value="file1">github.com/username/warikan/services/group/internal/repository/group.go (84.2%)</option>
				
				<option value="file2">github.com/username/warikan/services/group/internal/service/group.go (75.6%)</option>
				
				</select>
			</div>
			<div id="legend">
				<span>not tracked</span>
			
				<span class="cov0">not covered</span>
				<span class="cov8">covered</span>
			
			</div>
		</div>
		<div id="content">
		
		<pre class="file" id="file0" style="display: none">package handler

import (
        "context"

        groupv1 "github.com/username/warikan/services/group/proto"
)

type GroupHandler struct {
        groupv1.UnimplementedGroupServiceServer
        service GroupServiceInterface
}

func NewGroupHandler(service GroupServiceInterface) *GroupHandler <span class="cov8" title="1">{
        return &amp;GroupHandler{
                service: service,
        }
}</span>

func (h *GroupHandler) CreateGroup(ctx context.Context, req *groupv1.CreateGroupRequest) (*groupv1.CreateGroupResponse, error) <span class="cov8" title="1">{
        return h.service.CreateGroup(ctx, req)
}</span>

func (h *GroupHandler) GetGroup(ctx context.Context, req *groupv1.GetGroupRequest) (*groupv1.GetGroupResponse, error) <span class="cov8" title="1">{
        return h.service.GetGroup(ctx, req)
}</span>

func (h *GroupHandler) UpdateGroup(ctx context.Context, req *groupv1.UpdateGroupRequest) (*groupv1.UpdateGroupResponse, error) <span class="cov8" title="1">{
        return h.service.UpdateGroup(ctx, req)
}</span>

func (h *GroupHandler) DeleteGroup(ctx context.Context, req *groupv1.DeleteGroupRequest) (*groupv1.DeleteGroupResponse, error) <span class="cov8" title="1">{
        return h.service.DeleteGroup(ctx, req)
}</span>

func (h *GroupHandler) AddMember(ctx context.Context, req *groupv1.AddMemberRequest) (*groupv1.AddMemberResponse, error) <span class="cov8" title="1">{
        return h.service.AddMember(ctx, req)
}</span>

func (h *GroupHandler) RemoveMember(ctx context.Context, req *groupv1.RemoveMemberRequest) (*groupv1.RemoveMemberResponse, error) <span class="cov8" title="1">{
        return h.service.RemoveMember(ctx, req)
}</pre>
		
		<pre class="file" id="file1" style="display: none">package repository

import (
        "database/sql"
        "time"

        "github.com/google/uuid"
        _ "github.com/lib/pq"
        
        groupv1 "github.com/username/warikan/services/group/proto"
)

type GroupRepository struct {
        db *sql.DB
}

func NewGroupRepository(db *sql.DB) *GroupRepository <span class="cov8" title="1">{
        return &amp;GroupRepository{db: db}
}</span>

func (r *GroupRepository) CreateGroup(name, description, currency string, memberNames []string) (*groupv1.Group, error) <span class="cov8" title="1">{
        tx, err := r.db.Begin()
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov8" title="1">defer tx.Rollback()

        // Create group
        groupID := uuid.New().String()
        now := time.Now()
        
        _, err = tx.Exec(`
                INSERT INTO groups (id, name, description, currency, created_at, updated_at)
                VALUES ($1, $2, $3, $4, $5, $6)
        `, groupID, name, description, currency, now, now)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        // Create members
        <span class="cov8" title="1">var members []groupv1.Member
        for _, memberName := range memberNames </span><span class="cov8" title="1">{
                if memberName == "" </span><span class="cov8" title="1">{
                        continue</span>
                }
                
                <span class="cov8" title="1">memberID := uuid.New().String()
                _, err = tx.Exec(`
                        INSERT INTO members (id, group_id, name, joined_at)
                        VALUES ($1, $2, $3, $4)
                `, memberID, groupID, memberName, now)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, err
                }</span>

                <span class="cov8" title="1">members = append(members, groupv1.Member{
                        ID:       memberID,
                        Name:     memberName,
                        JoinedAt: now,
                })</span>
        }

        <span class="cov8" title="1">if err = tx.Commit(); err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov8" title="1">return &amp;groupv1.Group{
                ID:          groupID,
                Name:        name,
                Description: description,
                Currency:    currency,
                CreatedAt:   now,
                UpdatedAt:   now,
                Members:     members,
        }, nil</span>
}

func (r *GroupRepository) GetGroupByID(groupID string) (*groupv1.Group, error) <span class="cov8" title="1">{
        var group groupv1.Group
        err := r.db.QueryRow(`
                SELECT id, name, description, currency, created_at, updated_at
                FROM groups WHERE id = $1
        `, groupID).Scan(
                &amp;group.ID, &amp;group.Name, &amp;group.Description, &amp;group.Currency,
                &amp;group.CreatedAt, &amp;group.UpdatedAt,
        )
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        // Get members
        <span class="cov8" title="1">rows, err := r.db.Query(`
                SELECT id, name, email, joined_at
                FROM members WHERE group_id = $1
                ORDER BY joined_at ASC
        `, groupID)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov8" title="1">defer rows.Close()

        var members []groupv1.Member
        for rows.Next() </span><span class="cov8" title="1">{
                var member groupv1.Member
                var email sql.NullString
                
                err := rows.Scan(&amp;member.ID, &amp;member.Name, &amp;email, &amp;member.JoinedAt)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, err
                }</span>
                
                <span class="cov8" title="1">if email.Valid </span><span class="cov8" title="1">{
                        member.Email = email.String
                }</span>
                
                <span class="cov8" title="1">members = append(members, member)</span>
        }

        <span class="cov8" title="1">group.Members = members
        return &amp;group, nil</span>
}

func (r *GroupRepository) UpdateGroup(groupID, name, description, currency string) (*groupv1.Group, error) <span class="cov8" title="1">{
        now := time.Now()
        _, err := r.db.Exec(`
                UPDATE groups 
                SET name = $1, description = $2, currency = $3, updated_at = $4
                WHERE id = $5
        `, name, description, currency, now, groupID)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov8" title="1">return r.GetGroupByID(groupID)</span>
}

func (r *GroupRepository) DeleteGroup(groupID string) error <span class="cov8" title="1">{
        _, err := r.db.Exec("DELETE FROM groups WHERE id = $1", groupID)
        return err
}</span>

func (r *GroupRepository) AddMember(groupID, memberName, memberEmail string) (*groupv1.Member, error) <span class="cov8" title="1">{
        memberID := uuid.New().String()
        now := time.Now()

        _, err := r.db.Exec(`
                INSERT INTO members (id, group_id, name, email, joined_at)
                VALUES ($1, $2, $3, $4, $5)
        `, memberID, groupID, memberName, memberEmail, now)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov8" title="1">return &amp;groupv1.Member{
                ID:       memberID,
                Name:     memberName,
                Email:    memberEmail,
                JoinedAt: now,
        }, nil</span>
}

func (r *GroupRepository) RemoveMember(groupID, memberID string) error <span class="cov8" title="1">{
        _, err := r.db.Exec(`
                DELETE FROM members 
                WHERE id = $1 AND group_id = $2
        `, memberID, groupID)
        return err
}</pre>
		
		<pre class="file" id="file2" style="display: none">package service

import (
        "context"
        "errors"

        groupv1 "github.com/username/warikan/services/group/proto"
)

type GroupService struct {
        repo GroupRepositoryInterface
}

func NewGroupService(repo GroupRepositoryInterface) *GroupService <span class="cov8" title="1">{
        return &amp;GroupService{repo: repo}
}</span>

func (s *GroupService) CreateGroup(ctx context.Context, req *groupv1.CreateGroupRequest) (*groupv1.CreateGroupResponse, error) <span class="cov8" title="1">{
        if req.Name == "" </span><span class="cov8" title="1">{
                return nil, errors.New("group name is required")
        }</span>

        <span class="cov8" title="1">if req.Currency == "" </span><span class="cov8" title="1">{
                req.Currency = "JPY" // default currency
        }</span>

        <span class="cov8" title="1">group, err := s.repo.CreateGroup(req.Name, req.Description, req.Currency, req.MemberNames)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov8" title="1">return &amp;groupv1.CreateGroupResponse{
                Group: *group,
        }, nil</span>
}

func (s *GroupService) GetGroup(ctx context.Context, req *groupv1.GetGroupRequest) (*groupv1.GetGroupResponse, error) <span class="cov8" title="1">{
        if req.ID == "" </span><span class="cov8" title="1">{
                return nil, errors.New("group ID is required")
        }</span>

        <span class="cov8" title="1">group, err := s.repo.GetGroupByID(req.ID)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov8" title="1">return &amp;groupv1.GetGroupResponse{
                Group: *group,
        }, nil</span>
}

func (s *GroupService) UpdateGroup(ctx context.Context, req *groupv1.UpdateGroupRequest) (*groupv1.UpdateGroupResponse, error) <span class="cov8" title="1">{
        if req.ID == "" </span><span class="cov0" title="0">{
                return nil, errors.New("group ID is required")
        }</span>
        <span class="cov8" title="1">if req.Name == "" </span><span class="cov0" title="0">{
                return nil, errors.New("group name is required")
        }</span>

        <span class="cov8" title="1">group, err := s.repo.UpdateGroup(req.ID, req.Name, req.Description, req.Currency)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov8" title="1">return &amp;groupv1.UpdateGroupResponse{
                Group: *group,
        }, nil</span>
}

func (s *GroupService) DeleteGroup(ctx context.Context, req *groupv1.DeleteGroupRequest) (*groupv1.DeleteGroupResponse, error) <span class="cov8" title="1">{
        if req.ID == "" </span><span class="cov0" title="0">{
                return nil, errors.New("group ID is required")
        }</span>

        <span class="cov8" title="1">err := s.repo.DeleteGroup(req.ID)
        if err != nil </span><span class="cov8" title="1">{
                return nil, err
        }</span>

        <span class="cov8" title="1">return &amp;groupv1.DeleteGroupResponse{
                Success: true,
        }, nil</span>
}

func (s *GroupService) AddMember(ctx context.Context, req *groupv1.AddMemberRequest) (*groupv1.AddMemberResponse, error) <span class="cov8" title="1">{
        if req.GroupID == "" </span><span class="cov0" title="0">{
                return nil, errors.New("group ID is required")
        }</span>
        <span class="cov8" title="1">if req.MemberName == "" </span><span class="cov8" title="1">{
                return nil, errors.New("member name is required")
        }</span>

        <span class="cov8" title="1">member, err := s.repo.AddMember(req.GroupID, req.MemberName, req.MemberEmail)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov8" title="1">return &amp;groupv1.AddMemberResponse{
                Member: *member,
        }, nil</span>
}

func (s *GroupService) RemoveMember(ctx context.Context, req *groupv1.RemoveMemberRequest) (*groupv1.RemoveMemberResponse, error) <span class="cov8" title="1">{
        if req.GroupID == "" </span><span class="cov0" title="0">{
                return nil, errors.New("group ID is required")
        }</span>
        <span class="cov8" title="1">if req.MemberID == "" </span><span class="cov0" title="0">{
                return nil, errors.New("member ID is required")
        }</span>

        <span class="cov8" title="1">err := s.repo.RemoveMember(req.GroupID, req.MemberID)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov8" title="1">return &amp;groupv1.RemoveMemberResponse{
                Success: true,
        }, nil</span>
}</pre>
		
		</div>
	</body>
	<script>
	(function() {
		var files = document.getElementById('files');
		var visible;
		files.addEventListener('change', onChange, false);
		function select(part) {
			if (visible)
				visible.style.display = 'none';
			visible = document.getElementById(part);
			if (!visible)
				return;
			files.value = part;
			visible.style.display = 'block';
			location.hash = part;
		}
		function onChange() {
			select(files.value);
			window.scrollTo(0, 0);
		}
		if (location.hash != "") {
			select(location.hash.substr(1));
		}
		if (!visible) {
			select("file0");
		}
	})();
	</script>
</html>
